---
title: "Clustering"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{clustering}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, warning = FALSE, message = FALSE}
library(CyTOFtoolbox)
library(CATALYST)
library(diffcyt)
library(uwot)
library(SingleCellExperiment)
library(ggplot2)
```

# Introduction

This vignette retakes the 
[workflow of CATALYST](https://bioconductor.org/packages/release/bioc/vignettes/CATALYST/inst/doc/differential_analysis.html) 
for the clustering. The clustering is performed using a combination of two 
algorithms: `FlowSOM` clustering and `ConsensusClusterPlus` meta clustering.

The vignette proposes functions to modify the results visualizations:

- UMAP;
- Heatmaps.

# Data preprocessing

## Data 

We use the same data as proposed in the `CATALYST` workflow and prepare the data.

The dataset is the `Bodenmiller_BCR_XL` dataset originally from Bodenmiller et al. (2012).

```{r load_data, warning = FALSE, message = FALSE}
# Load data
data(PBMC_fs, PBMC_panel, PBMC_md)
# Prepare data
sce_Bodenmiller <- prepData(PBMC_fs, PBMC_panel, PBMC_md)
```

## Clustering analysis 

To perform the clustering, we need to specify the type markers on which the clustering
will be performed.

```{r clustering}
# Specify markers to use for clustering
type_markers(sce_Bodenmiller)
# Cluster
sce_Bodenmiller <- cluster(sce_Bodenmiller, 
                           features = type_markers(sce_Bodenmiller),
                           xdim = 10, ydim = 10, maxK = 20, 
                           verbose = FALSE, seed = 1234)
```

Based on the delta area plot which represent the stability gained when using
$k$ clusters, we can determine the *optimal* number of cluster:

```{r delta_aera_plot}
# Print the delta area plot
metadata(sce_Bodenmiller)$delta_area
```

## Dimensionality reduction with UMAP

Dimension reduction is computed with UMAP.

```{r UMAP}
# Extract data from sce object
umap_Bodenmiller_input_data <- t(assay(sce_Bodenmiller))
# UMAP dimensionality reduction
set.seed(1234)
dr_umap_Bodenmiller <- uwot::umap(umap_Bodenmiller_input_data, n_neighbors = 20, min_dist = 0.1)
# Add the dimensionality reduction to the SCE
colnames(dr_umap_Bodenmiller) <- c("X1", "X2")
reducedDims(sce_Bodenmiller) <- list("UMAP" = dr_umap_Bodenmiller)
```

## Differential Abundance (DA) tests

This test from the `diffcyt` package test for differential abundance of cell populations, i.e. clusters.

```{r DA_tests}
# Create design & constrast matrix
design_matrix_Bodenmiller <- createDesignMatrix(ei(sce_Bodenmiller), 
                                                cols_design = "condition")
contrast_Bodenmiller <- createContrast(c(0, 1))
# Test
res_DA_Bodenmiller <- diffcyt(sce_Bodenmiller, 
                              clustering_to_use = "meta8",
                              analysis_type = "DA", 
                              method_DA = "diffcyt-DA-edgeR",
                              design = design_matrix_Bodenmiller, 
                              contrast = contrast_Bodenmiller)
```

Additional notes for the analysis:

- With this dataset, the comparison is straightforward. However in case you need 
to filter for the comparison, the `filterSCE()` (from the `CATALYST` package)
function can be used.
- Factors in the metadata crashed the analysis

# Visualization

## Clusters

```{r}
# Extract DR info 
dr <- "UMAP" # input parameter
Bodenmiller_dr_values <- reducedDim(sce_Bodenmiller, dr)
## Extract colnames
names_dr <- colnames(Bodenmiller_dr_values)
# Combine with experiment info
## Combine colData with dimension reduction values
Bodenmiller_expinfo_dr_values <- data.frame(colData(sce_Bodenmiller),
                                            Bodenmiller_dr_values)
# Get cluster IDs info
Bodenmiller_cluster_name <- "meta8"
Bodenmiller_sce_metacluster_ids <- as.data.frame(cluster_ids(sce_Bodenmiller,
                                                             Bodenmiller_cluster_name))
colnames(Bodenmiller_sce_metacluster_ids) <- Bodenmiller_cluster_name
# Combine with experiment info and DR
Bodenmiller_expinfo_dr_metacluster_values <- data.frame(Bodenmiller_expinfo_dr_values,
                                                        Bodenmiller_sce_metacluster_ids)


## Point size
point_size <- 0.5
## Point transparency
point_alpha <- 0.5
## CATALYST colors for meta-cluster 
## (keeping the cluster colors defined by the CATALYST package)
catalyst_col <- CATALYST:::.cluster_cols
# Plot
ggplot(Bodenmiller_expinfo_dr_metacluster_values, aes_string(x = names_dr[1], y = names_dr[2])) +
  geom_point(aes(col = meta8), size = point_size, alpha = point_alpha, pch = 16) +
  scale_color_manual(values = catalyst_col, name = "8 meta-clusters") +
  labs(x = paste(dr, "1"), y = paste(dr, "2")) + 
  theme_bw() + 
  guides(colour = guide_legend(override.aes = list(size = 5, alpha = 1))) 
```
```{r cluster_savepng, eval = FALSE}
# Do not run
# To save the plot as a png image (in case the dataset contains too many points and cannot be saved as a PDF)
png(file = "PNG_clusters_meta8_Bodenmiller.png", width = 4000, height = 3800, unit = "px")
ggplot(Bodenmiller_expinfo_dr_metacluster_values, aes_string(x = names_dr[1], y = names_dr[2])) +
  geom_point(aes(col = meta8), size = 2, alpha = 0.1, pch = 16) +
  scale_color_manual(values = catalyst_col, name = "8 meta-clusters") +
  labs(x = paste(dr, "1"), y = paste(dr, "2")) + 
  theme_bw() + 
  guides(colour = guide_legend(override.aes = list(size = 30, alpha = 1))) +
  theme(axis.text = element_text(size = 70), axis.title = element_text(size = 80), 
        legend.title = element_text(size = 80), legend.text = element_text(size = 70),
        axis.ticks.length= unit(0.8, "cm"), axis.ticks = element_line(size = 2),
        panel.border = element_rect(size = 2), panel.grid.major = element_blank()) 
dev.off()
```


## DA test heatmap

```{r}
# Heatmap of DA testing results
## median (arcsinh-transformed) cell-type marker expressions (across all samples)
## relative cluster abundances by samples
plotDiffHeatmap(sce_Bodenmiller, 
                res_DA_Bodenmiller,
                th = 0.05,
                normalize = TRUE, 
                hm1 = FALSE, 
                row_anno = TRUE)
```
 
